"use client";

import {
  Anchor,
  Box,
  Button,
  MultiSelect,
  PasswordInput,
  Text,
  TextInput,
} from "@mantine/core";
import { useForm } from "@mantine/form";
import { registerUser } from "../../api/apiRegister";
import { getListProvinces } from "../../api/apigetlistaddress";
import { getWardsByProvince } from "../../api/apigetlistProvinces";
import { NotificationExtension } from "../../extension/NotificationExtension";
import { useState, useEffect } from "react";
import { useRouter } from "next/navigation";
import style from "./Register.module.css";

interface Register {
  fullName: string;
  email: string;
  phone: string;
  password: string;
  province: string[];
  ward: string[];
  introducer: string;
  detal_address: string;
}
interface Province {
  code: string;
  full_name_vi: string;
}
interface Ward {
  code: string;
  full_name_vi: string;
}

const RegisterForm = () => {
  const router = useRouter();

  const form = useForm<Register>({
    initialValues: {
      fullName: "",
      email: "",
      phone: "",
      password: "",
      province: [],
      ward: [],
      introducer: "",
      detal_address: "",
    },
    validate: {
      fullName: (value) =>
        value && value.trim() ? null : "H·ªç v√† t√™n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng",
      phone: (value) =>
        /^\d{10}$/.test(value.trim()) ? null : "S·ªë ƒëi·ªán tho·∫°i nh·∫≠p ƒë√∫ng 10 s·ªë!",
      password: (value) =>
        value && value.length >= 5 && value.length <= 100
          ? null
          : "M·∫≠t kh·∫©u ph·∫£i ch·ª©a t·ª´ 5 ƒë·∫øn 100 k√≠ t·ª±",
      email: (value) =>
        /^\S+@\S+\.\S+$/.test(value) ? null : "Email kh√¥ng h·ª£p l·ªá",
      detal_address: (value) =>
        value && value.trim() ? null : "Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ chi ti·∫øt",
    },
  });

  const [loading, setLoading] = useState(false);
  const [errorMsg, setErrorMsg] = useState<string | null>(null);
  const [successMsg, setSuccessMsg] = useState<string | null>(null);
  const [provinceOptions, setProvinceOptions] = useState<
    { value: string; label: string }[]
  >([]);
  const [wardOptions, setWardOptions] = useState<
    { value: string; label: string }[]
  >([]);

  // üß† state ri√™ng cho selectedProvince (tr√°nh useEffect b·ªã g·ªçi l·∫°i th·ª´a)
  const [selectedProvince, setSelectedProvince] = useState<string | null>(null);

  // Floating labels
  const [clickName, setClickName] = useState(false);
  const floatingName = clickName || form.values.fullName.length > 0 || undefined;
  const [clickPhone, setClickPhone] = useState(false);
  const floatingPhone = clickPhone || form.values.phone.length > 0 || undefined;
  const [clickPassword, setClickPassword] = useState(false);
  const floatingPassword =
    clickPassword || form.values.password.length > 0 || undefined;
  const [clickEmail, setClickEmail] = useState(false);
  const floatingEmail = clickEmail || form.values.email.length > 0 || undefined;
  const [clickProvince, setClickProvince] = useState(false);
  const floatingProvince =
    clickProvince || form.values.province.length > 0 || undefined;
  const [clickWard, setClickWard] = useState(false);
  const floatingWard = clickWard || form.values.ward.length > 0 || undefined;
  const [clickIntroducer, setClickIntroducer] = useState(false);
  const floatingIntroducer =
    clickIntroducer || form.values.introducer.length > 0 || undefined;
  const [clickDetail, setClickDetail] = useState(false);
  const floatingDetail =
    clickDetail || form.values.detal_address.length > 0 || undefined;

  // üèôÔ∏è L·∫•y danh s√°ch t·ªânh/th√†nh ph·ªë
  useEffect(() => {
    const fetchProvinces = async () => {
      try {
        const data: Province[] = await getListProvinces();
        const formatted = data.map((item) => ({
          value: item.code,
          label: item.full_name_vi,
        }));
        setProvinceOptions(formatted);
      } catch (error) {
        console.error("L·ªói khi l·∫•y danh s√°ch t·ªânh/th√†nh:", error);
      }
    };
    fetchProvinces();
  }, []);

  // üèòÔ∏è L·∫•y danh s√°ch ph∆∞·ªùng/x√£ khi ch·ªçn t·ªânh
  useEffect(() => {
    if (selectedProvince) {
      const fetchWards = async () => {
        try {
          const data: Ward[] = await getWardsByProvince(selectedProvince);
          const formatted = data.map((item) => ({
            value: item.code,
            label: item.full_name_vi,
          }));
          setWardOptions(formatted);
        } catch (error) {
          console.error("L·ªói khi l·∫•y danh s√°ch ph∆∞·ªùng/x√£:", error);
          setWardOptions([]);
        }
      };
      fetchWards();
    } else {
      setWardOptions([]);
    }
  }, [selectedProvince]);

  // Redirect sau khi ƒëƒÉng k√Ω th√†nh c√¥ng
  useEffect(() => {
    if (successMsg) {
      const timer = setTimeout(() => {
        router.push("/dang-nhap");
      }, 1000);
      return () => clearTimeout(timer);
    }
  }, [successMsg, router]);

  // X·ª≠ l√Ω submit form
  const handleSubmit = async (values: Register) => {
    try {
      setLoading(true);
      setErrorMsg(null);
      setSuccessMsg(null);

      const res = await registerUser(
        values.fullName,
        values.email,
        values.phone,
        values.password,
        values.province[0],
        values.ward[0],
        values.detal_address
      );

      console.log("‚úÖ ƒêƒÉng k√Ω th√†nh c√¥ng:", res);
      NotificationExtension.Success("ƒêƒÉng k√Ω th√†nh c√¥ng!");
      setSuccessMsg("ƒêƒÉng k√Ω th√†nh c√¥ng!");
    } catch (error: unknown) {
      console.error("‚ùå L·ªói ƒëƒÉng k√Ω:", error);
      if (error instanceof Error) {
        setErrorMsg(error.message);
        NotificationExtension.Fails(
          error.message || "C√≥ l·ªói x·∫£y ra khi ƒëƒÉng k√Ω"
        );
      } else {
        setErrorMsg("C√≥ l·ªói x·∫£y ra khi ƒëƒÉng k√Ω");
        NotificationExtension.Fails("C√≥ l·ªói x·∫£y ra khi ƒëƒÉng k√Ω");
      }
    } finally {
      setLoading(false);
    }
  };

  return (
    <Box
      className={style.registerPage}
      component="form"
      onSubmit={form.onSubmit(handleSubmit)}
    >
      <Box className={style.container}>
        <Box className={style.topNavBar}>
          <Box className={style.navBarContainer}>
            <Box className={style.navBarTitle}>
              ƒêƒÉng k√Ω t√†i kho·∫£n v√†o H·ªá th·ªëng
            </Box>
          </Box>
        </Box>

        <Box className={style.loginForm}>
          <Box className={style.formGroup}>
            {/* H·ªç v√† t√™n */}
            <div className={style.inputBox}>
              <TextInput
                label="H·ªç v√† t√™n"
                labelProps={{ "data-floating": floatingName }}
                withAsterisk
                mt="md"
                classNames={{
                  root: style.root,
                  input: style.input,
                  label: style.label,
                }}
                onFocus={() => setClickName(true)}
                onBlur={() => setClickName(false)}
                {...form.getInputProps("fullName")}
              />
            </div>

            {/* Email */}
            <div className={style.inputBox}>
              <TextInput
                label="Email"
                labelProps={{ "data-floating": floatingEmail }}
                withAsterisk
                mt="md"
                type="email"
                classNames={{
                  root: style.root,
                  input: style.input,
                  label: style.label,
                }}
                onFocus={() => setClickEmail(true)}
                onBlur={() => setClickEmail(false)}
                {...form.getInputProps("email")}
              />
            </div>

            {/* S·ªë ƒëi·ªán tho·∫°i */}
            <div className={style.inputBox}>
              <TextInput
                label="S·ªë ƒëi·ªán tho·∫°i"
                labelProps={{ "data-floating": floatingPhone }}
                withAsterisk
                type="number"
                mt="md"
                classNames={{
                  root: style.root,
                  input: style.input,
                  label: style.label,
                }}
                onFocus={() => setClickPhone(true)}
                onBlur={() => setClickPhone(false)}
                {...form.getInputProps("phone")}
              />
            </div>

            {/* M·∫≠t kh·∫©u */}
            <div className={style.inputBox}>
              <PasswordInput
                label="M·∫≠t kh·∫©u"
                labelProps={{ "data-floating": floatingPassword }}
                withAsterisk
                mt="md"
                classNames={{
                  root: style.root,
                  input: style.input,
                  label: style.label,
                }}
                onFocus={() => setClickPassword(true)}
                onBlur={() => setClickPassword(false)}
                {...form.getInputProps("password")}
              />
            </div>

            {/* Province */}
            <div className={style.inputBox}>
             <MultiSelect
  label="T·ªânh/Th√†nh ph·ªë"
  labelProps={{ "data-floating": floatingProvince }}
  withAsterisk
  mt="md"
  data={provinceOptions}
  classNames={{
    root: style.root,
    input: style.input,
    label: style.label,
  }}
  onFocus={() => setClickProvince(true)}
  onBlur={() => setClickProvince(false)}
  value={form.values.province}
  onChange={(values) => {
    // ‚úÖ ch·ªâ gi·ªØ l·∫°i option cu·ªëi c√πng (ng∆∞·ªùi d√πng ch·ªçn g·∫ßn nh·∫•t)
    const limited = values.slice(-1);
    form.setFieldValue("province", limited);
    setSelectedProvince(limited[0] || null);
    form.setFieldValue("ward", []); // reset ph∆∞·ªùng khi ƒë·ªïi t·ªânh
  }}
  searchable={false}
/>

            </div>

            {/* Ward */}
          {/* Ward */}
<MultiSelect
  label="Ph∆∞·ªùng/X√£"
  labelProps={{ "data-floating": floatingWard }}
  withAsterisk
  mt="md"
  data={wardOptions}
  classNames={{
    root: style.root,
    input: style.input,
    label: style.label,
  }}
  onFocus={() => setClickWard(true)}
  onBlur={() => setClickWard(false)}
  value={form.values.ward}
  onChange={(values) => {
    // ‚úÖ Ch·ªâ gi·ªØ l·∫°i 1 ph∆∞·ªùng/x√£ cu·ªëi c√πng m√† ng∆∞·ªùi d√πng ch·ªçn
    const limited = values.slice(-1);
    form.setFieldValue("ward", limited);
  }}
  searchable={false}
/>


            {/* M√£ ng∆∞·ªùi gi·ªõi thi·ªáu */}
            <div className={style.inputBox}>
              <TextInput
                label="M√£ ng∆∞·ªùi gi·ªõi thi·ªáu"
                labelProps={{ "data-floating": floatingIntroducer }}
                // withAsterisk
                mt="md"
                classNames={{
                  root: style.root,
                  input: style.input,
                  label: style.label,
                }}
                onFocus={() => setClickIntroducer(true)}
                onBlur={() => setClickIntroducer(false)}
                {...form.getInputProps("introducer")}
              />
            </div>

            {/* ƒê·ªãa ch·ªâ chi ti·∫øt */}
            <div className={style.inputBox}>
              <TextInput
                label="ƒê·ªãa ch·ªâ chi ti·∫øt"
                labelProps={{ "data-floating": floatingDetail }}
                withAsterisk
                mt="md"
                classNames={{
                  root: style.root,
                  input: style.input,
                  label: style.label,
                }}
                onFocus={() => setClickDetail(true)}
                onBlur={() => setClickDetail(false)}
                {...form.getInputProps("detal_address")}
              />
            </div>
          </Box>
        </Box>

        {errorMsg && <p style={{ color: "red", marginTop: "10px" }}>{errorMsg}</p>}
        {successMsg && <p style={{ color: "green", marginTop: "10px" }}>{successMsg}</p>}

        <Button className={style.btn} type="submit" loading={loading}>
          ƒêƒÉng k√Ω
        </Button>

        <Text style={{ textAlign: "center", marginTop: "16px" }}>
          B·∫°n ƒë√£ c√≥ t√†i kho·∫£n?{" "}
          <Anchor href="/dang-nhap" size="sm" c="red">
            ƒêƒÉng nh·∫≠p ngay
          </Anchor>
        </Text>
      </Box>
    </Box>
  );
};

export default RegisterForm;
